import os
import pandas as pd

# Caminho para o arquivo CSV e a pasta de saídaa
tabela = pd.read_csv(r'C:\Users\PC\Desktop\Creation-from-archive-to-import-ECF-validator\data\LINHA TESTE (1).csv', sep=';')
output_folder = r'C:\Users\PC\Desktop\ECF com movimento'

def ECF_RETIFICADORA():
    for linha in tabela.index:
        #IDENTIFICAÇÃO DA SCP RETIFICADORA
        VARIAVEL_RECIBO = tabela.loc[linha, 'recibo']
        VARIAVEL_CNPJ = tabela.loc[linha, 'cnpj']
        VARIAVEL_CPF = tabela.loc[linha, 'cpf']
        VARIAVEL_NOME = tabela.loc[linha, 'nome']
        #TRIMESTRE
        TRIMESTRE1 = tabela.loc[linha, 'TRI1']
        TRIMESTRE2 = tabela.loc[linha, 'TRI2']
        TRIMESTRE3 = tabela.loc[linha, 'TRI3']
        TRIMESTRE4 = tabela.loc[linha, 'TRI4']
        #VALOR DOS TRIMESTRES
        VARIAVEL_T1 = tabela.loc[linha, '1T']
        VARIAVEL_T2 = tabela.loc[linha, '2T']
        VARIAVEL_T3 = tabela.loc[linha, '3T']
        VARIAVEL_T4 = tabela.loc[linha, '4T']
        #TRIMESTRE 1 JÁ COM IMPOSTO CALCULADO
        VARIAVEL_B32T1 = tabela.loc[linha, 'BASE32%T1']
        VARIAVEL_I15D32T1 = tabela.loc[linha, 'IMP15%32T1']
        VARIAVEL_I9D32T1 = tabela.loc[linha, 'IMP9%32T1']
        #TRIMESTRE 2 JÁ COM IMPOSTO CALCULADO
        VARIAVEL_B32T2 = tabela.loc[linha, 'BASE32%T2']
        VARIAVEL_I15D32T2 = tabela.loc[linha, 'IMP15%32T2']
        VARIAVEL_I9D32T2 = tabela.loc[linha, 'IMP9%32T2']
        #TRIMESTRE 3 JÁ COM IMPOSTO CALCULADO
        VARIAVEL_B32T3 = tabela.loc[linha, 'BASE32%T3']
        VARIAVEL_I15D32T3 = tabela.loc[linha, 'IMP15%32T3']
        VARIAVEL_I9D32T3 = tabela.loc[linha, 'IMP9%32T3']
        #TRIMESTRE 4 JÁ COM IMPOSTO CALCULADO
        VARIAVEL_B32T4 = tabela.loc[linha, 'BASE32%T4']
        VARIAVEL_I15D32T4 = tabela.loc[linha, 'IMP15%32T4']
        VARIAVEL_I9D32T4 = tabela.loc[linha, 'IMP9%32T4']


        
        #falta o + antes do igual
        template_inicial = f'''|0000|LECF|0010|CNPJ|NOME DA OSTENSIVA|0|0|||01012023|31122023|S|{VARIAVEL_RECIBO}|2|{VARIAVEL_CNPJ}|
|0001|0|
|0010||N|5|T|01|PPPP||L||||1|
|0020|1||N|N|N|N|N|N|N|N|N|N|N|N|N|N|N|N|N|N|N|N|N|N|N|N|N|N|N|N|
|0030|2062|8610101|RUA |6||BAIRRO|PE|2604106|55014415|DDD+N|EMAIL|
|0930|PROCURADOR|CPF DO PROCURADOR|900|CRC|E-MAIL PROCURADOR|DDD+N|
|0930|PROCURADOR|CPF DO PROCURADOR|309||E-MAIL PROCURADOR|DDD+N|
|0990|8|
|P001|0|'''

        template_valort1 = f'''
|P030|01012023|31032023|{TRIMESTRE1}|
|P200|1|DISCRIMINAÇÃO DA RECEITA BRUTA||
|P200|8|Receita Bruta Sujeita ao Percentual de 32%|{VARIAVEL_T1}|
|P200|10|RESULTADO DA APLICAÇÃO DOS PERCENTUAIS SOBRE A RECEITA BRUTA AJUSTADO|{VARIAVEL_B32T1}|
|P200|26|BASE DE CÁLCULO DO IMPOSTO SOBRE O LUCRO PRESUMIDO|{VARIAVEL_B32T1}|
|P300|1|BASE DE CÁLCULO DO IMPOSTO SOBRE O LUCRO PRESUMIDO|{VARIAVEL_B32T1}|
|P300|2|IMPOSTO APURADO COM BASE NO LUCRO PRESUMIDO||
|P300|3|À Alíquota de 15%|{VARIAVEL_I15D32T1}|
|P300|6|DEDUÇÕES||
|P300|15|IMPOSTO DE RENDA A PAGAR|{VARIAVEL_I15D32T1}|
|P400|1|CÁLCULO DA CSLL||
|P400|4|Receita Bruta Sujeita ao Percentual de 32%|{VARIAVEL_T1}|
|P400|6|RESULTADO DA APLICAÇÃO DOS PERCENTUAIS SOBRE A RECEITA BRUTA AJUSTADO|{VARIAVEL_B32T1}|
|P400|21|BASE DE CÁLCULO DA CSLL|{VARIAVEL_B32T1}|
|P500|1|BASE DE CÁLCULO DA CSLL|{VARIAVEL_B32T1}|
|P500|2|CSLL Apurada|{VARIAVEL_I9D32T1}|
|P500|4|TOTAL DA CONTRIBUIÇÃO SOCIAL SOBRE O LUCRO LÍQUIDO|{VARIAVEL_I9D32T1}|
|P500|5|DEDUÇÕES||
|P500|13|CSLL A PAGAR|{VARIAVEL_I9D32T1}|'''
        
        template_valort2 = f'''
|P030|01042023|30062023|{TRIMESTRE2}|
|P200|1|DISCRIMINAÇÃO DA RECEITA BRUTA||
|P200|8|Receita Bruta Sujeita ao Percentual de 32%|{VARIAVEL_T2}|
|P200|10|RESULTADO DA APLICAÇÃO DOS PERCENTUAIS SOBRE A RECEITA BRUTA AJUSTADO|{VARIAVEL_B32T2}|
|P200|26|BASE DE CÁLCULO DO IMPOSTO SOBRE O LUCRO PRESUMIDO|{VARIAVEL_B32T2}|
|P300|1|BASE DE CÁLCULO DO IMPOSTO SOBRE O LUCRO PRESUMIDO|{VARIAVEL_B32T2}|
|P300|2|IMPOSTO APURADO COM BASE NO LUCRO PRESUMIDO||
|P300|3|À Alíquota de 15%|{VARIAVEL_I15D32T2}|
|P300|6|DEDUÇÕES||
|P300|15|IMPOSTO DE RENDA A PAGAR|{VARIAVEL_I15D32T2}|
|P400|1|CÁLCULO DA CSLL||
|P400|4|Receita Bruta Sujeita ao Percentual de 32%|{VARIAVEL_T2}|
|P400|6|RESULTADO DA APLICAÇÃO DOS PERCENTUAIS SOBRE A RECEITA BRUTA AJUSTADO|{VARIAVEL_B32T2}|
|P400|21|BASE DE CÁLCULO DA CSLL|{VARIAVEL_B32T2}|
|P500|1|BASE DE CÁLCULO DA CSLL|{VARIAVEL_B32T2}|
|P500|2|CSLL Apurada|{VARIAVEL_I9D32T2}|
|P500|4|TOTAL DA CONTRIBUIÇÃO SOCIAL SOBRE O LUCRO LÍQUIDO|{VARIAVEL_I9D32T2}|
|P500|5|DEDUÇÕES||
|P500|13|CSLL A PAGAR|{VARIAVEL_I9D32T2}|'''
        
        template_valort3 = f'''
|P030|01072023|30092023|{TRIMESTRE3}|
|P200|1|DISCRIMINAÇÃO DA RECEITA BRUTA||
|P200|8|Receita Bruta Sujeita ao Percentual de 32%|{VARIAVEL_T3}|
|P200|10|RESULTADO DA APLICAÇÃO DOS PERCENTUAIS SOBRE A RECEITA BRUTA AJUSTADO|{VARIAVEL_B32T3}|
|P200|26|BASE DE CÁLCULO DO IMPOSTO SOBRE O LUCRO PRESUMIDO|{VARIAVEL_B32T3}|
|P300|1|BASE DE CÁLCULO DO IMPOSTO SOBRE O LUCRO PRESUMIDO|{VARIAVEL_B32T3}|
|P300|2|IMPOSTO APURADO COM BASE NO LUCRO PRESUMIDO||
|P300|3|À Alíquota de 15%|{VARIAVEL_I15D32T3}|
|P300|6|DEDUÇÕES||
|P300|15|IMPOSTO DE RENDA A PAGAR|{VARIAVEL_I15D32T3}|
|P400|1|CÁLCULO DA CSLL||
|P400|4|Receita Bruta Sujeita ao Percentual de 32%|{VARIAVEL_T3}|
|P400|6|RESULTADO DA APLICAÇÃO DOS PERCENTUAIS SOBRE A RECEITA BRUTA AJUSTADO|{VARIAVEL_B32T3}|
|P400|21|BASE DE CÁLCULO DA CSLL|{VARIAVEL_B32T3}|
|P500|1|BASE DE CÁLCULO DA CSLL|{VARIAVEL_B32T3}|
|P500|2|CSLL Apurada|{VARIAVEL_I9D32T3}|
|P500|4|TOTAL DA CONTRIBUIÇÃO SOCIAL SOBRE O LUCRO LÍQUIDO|{VARIAVEL_I9D32T3}|
|P500|5|DEDUÇÕES||
|P500|13|CSLL A PAGAR|{VARIAVEL_I9D32T3}|'''
        
        template_valort4 = f'''
|P030|01102023|31122023|{TRIMESTRE4}|
|P200|1|DISCRIMINAÇÃO DA RECEITA BRUTA||
|P200|8|Receita Bruta Sujeita ao Percentual de 32%|{VARIAVEL_T4}|
|P200|10|RESULTADO DA APLICAÇÃO DOS PERCENTUAIS SOBRE A RECEITA BRUTA AJUSTADO|{VARIAVEL_B32T4}|
|P200|26|BASE DE CÁLCULO DO IMPOSTO SOBRE O LUCRO PRESUMIDO|{VARIAVEL_B32T4}|
|P300|1|BASE DE CÁLCULO DO IMPOSTO SOBRE O LUCRO PRESUMIDO|{VARIAVEL_B32T4}|
|P300|2|IMPOSTO APURADO COM BASE NO LUCRO PRESUMIDO||
|P300|3|À Alíquota de 15%|{VARIAVEL_I15D32T4}|
|P300|6|DEDUÇÕES||
|P300|15|IMPOSTO DE RENDA A PAGAR|{VARIAVEL_I15D32T4}|
|P400|1|CÁLCULO DA CSLL||
|P400|4|Receita Bruta Sujeita ao Percentual de 32%|{VARIAVEL_T4}|
|P400|6|RESULTADO DA APLICAÇÃO DOS PERCENTUAIS SOBRE A RECEITA BRUTA AJUSTADO|{VARIAVEL_B32T4}|
|P400|21|BASE DE CÁLCULO DA CSLL|{VARIAVEL_B32T4}|
|P500|1|BASE DE CÁLCULO DA CSLL|{VARIAVEL_B32T4}|
|P500|2|CSLL Apurada|{VARIAVEL_I9D32T4}|
|P500|4|TOTAL DA CONTRIBUIÇÃO SOCIAL SOBRE O LUCRO LÍQUIDO|{VARIAVEL_I9D32T4}|
|P500|5|DEDUÇÕES||
|P500|13|CSLL A PAGAR|{VARIAVEL_I9D32T4}|
'''
        
        template_zerado1 = f'''
|P030|01012023|31032023|{TRIMESTRE1}|
|P200|1|DISCRIMINAÇÃO DA RECEITA BRUTA||
|P300|2|IMPOSTO APURADO COM BASE NO LUCRO PRESUMIDO||
|P300|6|DEDUÇÕES||
|P400|1|CÁLCULO DA CSLL||
|P500|5|DEDUÇÕES||'''
        
        template_zerado2 = f'''
|P030|01042023|30062023|{TRIMESTRE2}|
|P200|1|DISCRIMINAÇÃO DA RECEITA BRUTA||
|P300|2|IMPOSTO APURADO COM BASE NO LUCRO PRESUMIDO||
|P300|6|DEDUÇÕES||
|P400|1|CÁLCULO DA CSLL||
|P500|5|DEDUÇÕES||'''
        
        template_zerado3 = f'''
|P030|01072023|30092023|{TRIMESTRE3}|
|P200|1|DISCRIMINAÇÃO DA RECEITA BRUTA||
|P300|2|IMPOSTO APURADO COM BASE NO LUCRO PRESUMIDO||
|P300|6|DEDUÇÕES||
|P400|1|CÁLCULO DA CSLL||
|P500|5|DEDUÇÕES||'''
        
        template_zerado4 = f'''
|P030|01102023|31122023|{TRIMESTRE4}|
|P200|1|DISCRIMINAÇÃO DA RECEITA BRUTA||
|P300|2|IMPOSTO APURADO COM BASE NO LUCRO PRESUMIDO||
|P300|6|DEDUÇÕES||
|P400|1|CÁLCULO DA CSLL||
|P500|5|DEDUÇÕES||'''
        
        

        BLOCO_INICIAL = template_inicial
        #Testa o valor do trimestre para a construção do bloco com ou sem valor
        if VARIAVEL_T1 !=0:
            BLOCO1 = template_valort1
        
        else:
            BLOCO1 = template_zerado1

        if VARIAVEL_T2 !=0:
            BLOCO2 = template_valort2
        
        else:
            BLOCO2 = template_zerado2    
            
        if VARIAVEL_T3 !=0:
            BLOCO3 = template_valort3
        
        else:
            BLOCO3 = template_zerado3    

        if VARIAVEL_T4 !=0:
            BLOCO4 = template_valort4
        
        else:
            BLOCO4 = template_zerado4
        
        
        #conta o total de linhas do arquivo
        BLOCO_TEMP = f"{BLOCO_INICIAL}{BLOCO1}{BLOCO2}{BLOCO3}{BLOCO4}"

        CONT_LINHA_TEMP = len(BLOCO_TEMP.splitlines())
    
        #conta linha e adiciona as linhas do bloco final
        CONT_LINHA = CONT_LINHA_TEMP + 38
        
        #Conta todas as ocorrências de |P, |P200 e os demais e guarda na variavel
        CONT_P = len([linha for linha in BLOCO_TEMP.splitlines() if '|P' in linha]) - 2
        
        CONT_P200 = len([linha for linha in BLOCO_TEMP.splitlines() if '|P200' in linha])

        CONT_P300 = len([linha for linha in BLOCO_TEMP.splitlines() if '|P300' in linha])

        CONT_P400 = len([linha for linha in BLOCO_TEMP.splitlines() if '|P400' in linha])

        CONT_P500 = len([linha for linha in BLOCO_TEMP.splitlines() if '|P500' in linha])

        template_final = f'''|P990|{CONT_P}|
|Q001|0|
|Q100|01012023||SALDO ANTERIOR|0,00|0,00|0,00|
|Q990|3|
|Y001|0|
|Y600|04092017||105|PF|{VARIAVEL_CPF}|{VARIAVEL_NOME}|02|83,6700|0,00|||0,00|0,00|0,00|0,00|0,00|
|Y600|04092017||105|PJ|CNPJ|NOME DA OSTENSIVA|04|16,3300|0,00|||0,00|0,00|0,00|0,00|0,00|
|Y672|0,00|0,00|0,00|0,00|0,00|0,00|0,00|0,00|0,00|0,00|0,00|0,00|0,00|0,00|0,00|0,00|1|
|Y720||||N||
|Y990|6|
|9001|0|
|9900|0000|1|||
|9900|0001|1|||
|9900|0010|1|||
|9900|0020|1|||
|9900|0030|1|||
|9900|0930|2|||
|9900|0990|1|||
|9900|P001|1|||
|9900|P030|4|||
|9900|P200|{CONT_P200}|||
|9900|P300|{CONT_P300}|||
|9900|P400|{CONT_P400}|||
|9900|P500|{CONT_P500}|||
|9900|P990|1|||
|9900|Q001|1|||
|9900|Q100|1|||
|9900|Q990|1|||
|9900|Y001|1|||
|9900|Y600|2|||
|9900|Y672|1|||
|9900|Y720|1|||
|9900|Y990|1|||
|9900|9001|1|||
|9900|9900|26|||
|9900|9990|1|||
|9900|9999|1|||
|9990|29|
|9999|{CONT_LINHA}|\n'''
        
        BLOCO_FINAL = template_final

        #monta ECF
        ECF = f"{BLOCO_TEMP}{BLOCO_FINAL}"
        #nomeia os arquivos
        NOME_ARQ = str(VARIAVEL_CNPJ)+'.txt'
        #gera os arquivos na pasta apontada
        DIRETORIO = r'C:\Users\PC\Desktop\CSV E ECF'
        os.makedirs(DIRETORIO, exist_ok=True)

        CAMINHO_ARQ = os.path.join(DIRETORIO, NOME_ARQ)

        with open(CAMINHO_ARQ, 'w') as arquivo:
            arquivo.write(str(ECF))

ECF_RETIFICADORA()
    